---

- name: create site directories
  file: 
    path: /var/www/{{ item.name }}
    state: directory
  with_items:
  - "{{ static_sites }}"

- name: create sample index
  template: 
    src: index.html.j2
    dest: /var/www/{{ item.name }}/index.html
  with_items:
  - "{{ static_sites }}"
  when: "{{ test_mode }}"

- name: create configuration directory
  file: 
    path: /var/lib/nginx
    state: directory

- name: clone nginx-lua-prometheus
  git:
    repo: https://github.com/knyar/nginx-lua-prometheus.git
    dest: /var/lib/nginx/lua

- name: copy static files
  copy: 
    src: "{{ item }}"
    dest: /var/lib/nginx/{{ item }}
  with_items:
  - mime.types

- name: create main configuration
  template:
    src: nginx.conf.j2
    dest: /var/lib/nginx/nginx.conf

- name: create jasas directory
  file: 
    path: /var/lib/jasas
    state: directory

- name: check jasas passwd
  command:
    docker run --rm -v /var/lib/jasas:/data -e JASAS_PASSWD_PATH=/data/passwd.db sdorra/jasas:0.1.0 passwd exists {{ admin.name }}
  register: passwd_result
  no_log: True
  ignore_errors: True
  changed_when: False

- name: add admin to jasas passwd
  command:
    docker run --rm -v /var/lib/jasas:/data -e JASAS_PASSWD_PATH=/data/passwd.db sdorra/jasas:0.1.0 passwd put {{ admin.name }} {{ admin.password }}
  no_log: True
  when: passwd_result.rc != 0

- name: create site configuration directory
  file: 
    path: /var/lib/nginx/conf.d
    state: directory

- name: copy static site files
  copy: 
    src: "{{ item }}.conf"
    dest: /var/lib/nginx/conf.d/{{ item }}.conf
  with_items:
  - metrics

- name: proxy configurations
  template:
    src: proxy.conf.j2
    dest: /var/lib/nginx/conf.d/{{ item.name }}.conf
  with_items:
  - name: auth
    port: 8000
    auth_required: false
  - name: cadvisor
    port: 8080
    auth_required: true
  - name: prometheus
    port: 9090
    auth_required: true
  - name: grafana
    port: 3000
    auth_required: true
  - name: kibana
    port: 5601
    auth_required: true

- name: create site configuration
  template:
    src: static.conf.j2
    dest: /var/lib/nginx/conf.d/{{ item.name }}.conf
  with_items:
  - "{{ static_sites }}"

- name: auth container
  docker_container:
    name: auth
    image: sdorra/jasas:0.1.0
    restart_policy: always
    env:
      JASAS_DOMAIN: "{{ domain }}"
      JASAS_JWK_PATH: /data/keys.jwk
      JASAS_PASSWD_PATH: /data/passwd.db
    networks:
    - name: network_one
    volumes:
    - /var/lib/jasas:/data

- name: nginx container
  docker_container:
    name: nginx
    image: sdorra/nginx:1.11.8
    restart_policy: always
    networks:
    - name: network_one
    ports:
    - "80:80"
    - "443:443"
    volumes:
    - /var/lib/nginx:/etc/nginx:ro
    - /var/www:/var/www:ro
    log_driver: gelf
    log_options: 
      gelf-address: udp://localhost:12201
      tag: nginx

- name: open port 80
  ufw:
    rule: allow
    port: 80

- name: open port 443
  ufw:
    rule: allow
    port: 443
